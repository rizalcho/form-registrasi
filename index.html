<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrasi e-TeraJANA</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: url('images/IMG_20220701_183445.jpg') no-repeat center center fixed;
            background-color: #f4f4f4; /* Warna cadangan */
            background-size: cover;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }        
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Opacity 50% */
            z-index: -1;
        }
      .form-container {
        max-width: 500px;
        margin: auto;
        margin-top: 10px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        background-color: rgba(243, 243, 243, 0.9);
        z-index: 1;
        border-radius: 10px;
      }
      .logo {
    max-width: 400px; /* Ukuran maksimum logo */
    margin-bottom: 10px; /* Jarak antara logo dan heading */
    }

      .form-check {
      display: none;
      }
    .custom-btn {
    background-color: #0db20f !important; /* Warna oranye */
    border-color: #0db20f !important;
    color: white !important; /* Warna teks */
}
.custom-btn:hover {
    background-color: #0b7e0d !important; /* Warna oranye */
    border-color: #0b7e0d !important;
    color: white !important; /* Warna teks */
}
.modal-content {
            max-width: 800px;
            margin: auto;
            background: rgb(255, 255, 255);
            border-color: rgba(44, 221, 77, 0.782);
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            /* text-align: center; */
        }
.modal-header {
    background-color: rgba(44, 221, 76, 0.821); /* Ganti dengan warna yang diinginkan */
    color: white; /* Ubah warna teks agar kontras */
}

    </style>
  </head>
  <div class="background-overlay"></div>
  <body class="bg-light">
    <div class="container">
      <img src="images/e-TeraJANA.png" alt="Logo" class="logo d-block mx-auto img-fluid"> <!-- Gambar di atas kontainer -->
      <div class="form-container">
        
        <h4 class="text-center mb-4">Registrasi</h4>
        <form id="submit-to-google-sheet">
            <div class="mb-2">
                <select class="form-control" name="status" id="status" onchange="showizinreparatir()" required>
                <option value="">Mendaftar Sebagai</option>
                <option value="pemilik">Pemilik UTTP</option>
                <option value="rekanan">Rekanan (Pihak ke-3)</option>
                </select>
            </div>
            <div class="mb-2">
                <input class="form-control" type="email" name="email" id="email" placeholder="Email" required/>
            </div>
            <div class="mb-2">
                <input class="form-control" type="password" name="password" id="password" placeholder="Password (min. 8 karakter)" required />
            </div>
            <div class="mb-2">
                <input class="form-control" type="text" name="nama" id="nama" placeholder="Nama Lengkap Badan Usaha/Perorangan" required/>
          </div>
          <div class="mb-2">
            <textarea class="form-control" name="alamat" id="alamat" placeholder="Alamat Lengkap (jalan, Desa/Kel, Kec., Kab.)" required></textarea>
        </div>
        <div class="mb-2">
            <select class="form-control" name="kecamatan" id="kecamatan" required>
                <option value="">Kecamatan (untuk database)</option>      
                <option value="Balongbendo">Balongbendo</option>
                <option value="Buduran">Buduran</option>
                <option value="Candi">Candi</option>
                <option value="Gedangan">Gedangan</option>
                <option value="Jabon">Jabon</option>
                <option value="Krembung">Krembung</option>
                <option value="Krian">Krian</option>
                <option value="Porong">Porong</option>
                <option value="Prambon">Prambon</option>
                <option value="Sedati">Sedati</option>
                <option value="Sidoarjo">Sidoarjo</option>
                <option value="Sukodono">Sukodono</option>
                <option value="Taman">Taman</option>
                <option value="Tanggulangin">Tanggulangin</option>
                <option value="Tarik">Tarik</option>
                <option value="Tulangan">Tulangan</option>
                <option value="Wonoayu">Wonoayu</option>
                <option value="Waru">Waru</option>
                <option value="Luar Sidoarjo">Luar Sidoarjo</option>
            </select>
        </div>
          <div class="mb-2">
            <input class="form-control" type="text" name="kontak" id="kontak" pattern="[0-9+]+" inputmode="numeric" placeholder="Kontak (Whatsapp)" required/>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="izin_reparatir" />
            <label class="form-check-label" for="izin_reparatir"
              >Punya Izin Reparatir?</label>
          </div>
          <div class="mb-2">
                <label for="media" class="form-label" id="documentLabel">Unggah File Dokumen :</label>
                <input class="form-control" type="file" name="media" id="media" accept=".pdf, .jpg, .jpeg, .png" required />
            </div>
            <div class="form-check1 mb-3">
              <input class="form-check-input" type="checkbox" id="snk" required />
              <label class="form-check-label"
                >Saya Menyetujui  
                <a href="#" data-bs-toggle="modal" data-bs-target="#snkmodal">Syarat & Ketentuan</a>
                 yang Berlaku
              </label>
            </div> 
          <button type="submit" class="btn custom-btn w-100">Submit</button>
          <div class="text-center mt-2">
            <p>Sudah punya akun? <a href="login.html" class="font-weight-bold">Login di sini</a></p>
        </div>        
        </form>
      </div>
    </div>
    <!-- Modal SnK -->
<div class="modal fade" id="snkmodal" tabindex="-1" role="dialog" aria-labelledby="forgotPasswordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="snkModalLabel">Syarat & Ketentuan</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ol>
              <li>Aplikasi e-TeraJANA merupakan sarana sistem pelayanan Tera/Tera Ulang pada UPTD Metrologi Legal Kab. Sidoarjo</li>
              <li>Setiap pelayanan Tera/Tera Ulang dilaksanakan pada pengguna yang memiliki akun pada aplikasi</li>
              <li>Pengguna yang dapat mendaftar akun adalah Wajib Tera (Pemilik, Penjual UTTP) dan Rekanan/Jasa Reparatir UTTP</li>
              <li>Pengguna wajib mengisi formulir pendaftaran pada halaman registrasi</li>
              <li>Pengguna Wajib Tera wajib mengunggah dokumen persyaratan berupa Kartu NPWP untuk Badan Usaha atau Kartu Identitas yang Sah (KTP/SIM/dsb) untuk Perorangan</li>
              <li>Pengguna Rekanan wajib mengunggah dokumen persyaratan berupa Tanda Daftar Reparatir (TDR) atau Kartu NPWP untuk yang belum memiliki TDR</li>
              <li>Dokumen persyaratan hanya digunakan dalam proses verifikasi akun dan akan terhapus otomatis dari server e-TeraJANA setelah proses verifikasi selesai</li>
              <li>Proses verifikasi akun memerlukan waktu 1x24 jam (Hari Kerja)</li>
              <li>Pengguna yang telah terverifikasi akan mendapatkan pesan konfirmasi melalui whatsapp dan dapat melakukan proses login</li>
              <li>UPTD Metrologi Legal berhak memblokir/menonaktifkan akun apabila terjadi pelanggaran dalam penggunaan Aplikasi e-TeraJANA</li>
          </ol>
          </div>
      </div>
  </div>
</div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycby9oWFG1KOvNNV1NsaMZDC_G00BJ7ovFD4LdgvctDtp5Nh77MWty7hrYERe55EShQgC/exec";
        const form = document.forms["submit-to-google-sheet"];
        const fileInput = document.getElementById("media");
    
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            formData.append("action", "register"); // Tambahkan action untuk register

            const password = document.getElementById("password").value;
             if (password.length < 8) {
            swal.fire("Error", "Password harus minimal 8 karakter!", "error");
            return;
            }
                // Hash password sebelum dikirim
            const passwordInput = document.getElementById("password").value;
            const hashedPassword = await hashPassword(passwordInput);
            formData.set("password", hashedPassword); // Ganti password dengan versi yang di-hash

            var izin_reparatir = document.getElementById("izin_reparatir").checked;
    
            if (izin_reparatir) {
                formData.append("izin_reparatir", "Yes");
            } else {
                formData.append("izin_reparatir", "No");
            }
            const snk = document.getElementById("snk").checked;
    
            if (snk) {
                formData.append("snk", "Yes");
            } else {
                formData.append("snk", "No");
            }
            // Handle file upload (PDF atau gambar)
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                const allowedTypes = ["image/jpeg", "image/png", "application/pdf"];
    
                // Validasi ukuran file (maksimal 2MB)
                if (file.size > 2 * 1024 * 1024) {
                    swal.fire("Error", "File size should be less than 2MB.", "error");
                    return;
                }
    
                // Validasi tipe file yang diizinkan
                if (!allowedTypes.includes(file.type)) {
                    swal.fire("Error", "Only JPG, PNG, and PDF files are allowed.", "error");
                    return;
                }
                reader.onload = async function () {
                    const base64Data = reader.result.split(",")[1]; // Menghapus metadata base64
                    formData.append("media", base64Data);
                    formData.append("mediaType", file.type); // Mengirim tipe file
                    await submitForm(formData);
                };
                reader.readAsDataURL(file); // Konversi ke Base64
            } else {
                // Jika tidak ada file yang diunggah
                await submitForm(formData);
            }
        });
        async function submitForm(formData) {
    const submitButton = document.querySelector("button[type='submit']");
    submitButton.disabled = true;
    submitButton.innerText = "Loading...";

    try {
        const response = await fetch(scriptURL, { method: "POST", body: formData });
        const result = await response.json();

        if (result.result === "success") {
            swal.fire("Berhasil", "akun anda akan diverifikasi maks. 1x24 jam.", "success")
            .then(() => {
                window.location.href = "login.html"; // Arahkan ke halaman login
            });
            form.reset();
        } else if (result.message === "Email already exists") {
            swal.fire("Gagal", "email sudah terdaftar!", "error");
        } else {
            swal.fire("Error", "Something went wrong. Please try again!", "error");
        }
    } catch (error) {
        swal.fire("Error", "Failed to submit. Check your internet connection!", "error");
    } finally {
        submitButton.disabled = false;
        submitButton.innerText = "Submit";
    }
}

        async function hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(byte => byte.toString(16).padStart(2, "0")).join("");
}

function showizinreparatir() {
            const status = document.getElementById("status").value;
            const ceklis = document.querySelector(".form-check");
            const documentLabel = document.getElementById("documentLabel");
            if (status === "rekanan") {
              ceklis.style.display = "block";
                documentLabel.textContent = "Unggah Izin Reparatir, jika belum punya unggah surat pernyataan (PDF atau jpg)";
            } else {
                ceklis.style.display = "none";
                documentLabel.textContent = "Unggah Surat Pernyataan (PDF atau gambar)";
            }
        }
    </script>
    
  </body>
</html>